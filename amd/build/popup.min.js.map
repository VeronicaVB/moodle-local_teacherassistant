{"version":3,"file":"popup.min.js","sources":["../src/popup.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * Teacher Assistant popup functionality.\n *\n * @module     local_teacherassistant/popup\n * @copyright  2025 Your Name\n * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later\n */\n\nimport Templates from 'core/templates';\nimport Ajax from 'core/ajax';\nimport Notification from 'core/notification';\n\nclass PopupManager {\n    constructor(courseId) {\n        this.isMinimized = true;\n        this.courseId = courseId;\n    }\n\n    /**\n     * Initialize the popup.\n     */\n    async init() {\n        await this.render();\n        this.attachEventHandlers();\n    }\n\n    /**\n     * Render the popup template.\n     */\n    async render() {\n        console.log('Rendering Teacher Assistant popup');\n        try {\n            // Get course ID from body class\n            // const bodyClasses = document.body.className;\n            // const courseMatch = bodyClasses.match(/course-(\\d+)/);\n            // this.courseId = courseMatch ? courseMatch[1] : null;\n\n             let container = document.getElementById('teacherassistant-container');\n\n            if (!container) {\n                container = document.createElement('div');\n                container.id = 'teacherassistant-container';\n                document.body.appendChild(container);\n            }\n\n\n            const context = {\n                courseid: this.courseId\n            };\n\n            console.log('Rendering popup with context:', context);\n            const html = await Templates.render('local_teacherassistant/popup', context);\n            // const container = document.getElementById('teacherassistant-container');\n\n            console.log(html);\n            if (container) {\n                container.innerHTML = html;\n            }\n        } catch (error) {\n            Notification.exception(error);\n        }\n    }\n\n    /**\n     * Attach event handlers to popup elements.\n     */\n    attachEventHandlers() {\n        const toggleBtn = document.getElementById('teacherassistant-toggle-btn');\n        const minimizeBtn = document.getElementById('teacherassistant-minimize-btn');\n        const expandBtn = document.getElementById('teacherassistant-expand-btn');\n        const sendBtn = document.getElementById('teacherassistant-send-btn');\n        const input = document.getElementById('teacherassistant-input');\n\n        if (toggleBtn) {\n            toggleBtn.addEventListener('click', () => this.togglePopup());\n        }\n\n        if (minimizeBtn) {\n            minimizeBtn.addEventListener('click', () => this.minimizePopup());\n        }\n\n        if (expandBtn) {\n            expandBtn.addEventListener('click', () => this.expandToFullPage());\n        }\n\n        if (sendBtn) {\n            sendBtn.addEventListener('click', () => this.sendMessage());\n        }\n\n        if (input) {\n            input.addEventListener('keydown', (e) => {\n                if (e.key === 'Enter' && !e.ctrlKey && !e.shiftKey) {\n                    e.preventDefault();\n                    this.sendMessage();\n                }\n            });\n        }\n    }\n\n    /**\n     * Toggle popup visibility.\n     */\n    togglePopup() {\n        const popup = document.getElementById('teacherassistant-popup');\n        const content = document.getElementById('teacherassistant-content');\n\n        if (!popup || !content) {\n            return;\n        }\n\n        if (this.isMinimized) {\n            popup.classList.remove('teacherassistant-minimized');\n            popup.classList.add('teacherassistant-expanded');\n            content.style.display = 'flex';\n            this.isMinimized = false;\n        } else {\n            this.minimizePopup();\n        }\n    }\n\n    /**\n     * Minimize the popup.\n     */\n    minimizePopup() {\n        const popup = document.getElementById('teacherassistant-popup');\n        const content = document.getElementById('teacherassistant-content');\n\n        if (!popup || !content) {\n            return;\n        }\n\n        content.style.display = 'none';\n        popup.classList.remove('teacherassistant-expanded');\n        popup.classList.add('teacherassistant-minimized');\n        this.isMinimized = true;\n    }\n\n    /**\n     * Expand to full page.\n     */\n    expandToFullPage() {\n        if (this.courseId) {\n            const url = `${M.cfg.wwwroot}/local/teacherassistant/chat.php?courseid=${this.courseId}`;\n            window.open(url, '_blank');\n        }\n    }\n\n    /**\n     * Send a message.\n     */\n    async sendMessage() {\n        const input = document.getElementById('teacherassistant-input');\n        const message = input?.value.trim();\n\n        if (!message) {\n            return;\n        }\n\n        // Add user message to chat\n        this.addMessage(message, 'user');\n\n        // Clear input\n        input.value = '';\n\n        // Show loading indicator\n        this.showLoading();\n\n        try {\n            // Make AJAX call to backend\n            const response = await Ajax.call([{\n                methodname: 'local_teacherassistant_send_message',\n                args: {\n                    courseid: this.courseId,\n                    message: message\n                }\n            }])[0];\n\n            this.hideLoading();\n            this.addMessage(response.message, 'assistant');\n        } catch (error) {\n            this.hideLoading();\n            Notification.exception(error);\n        }\n    }\n\n    /**\n     * Add a message to the chat.\n     *\n     * @param {string} text - The message text\n     * @param {string} sender - 'user' or 'assistant'\n     */\n    addMessage(text, sender) {\n        const messagesContainer = document.getElementById('teacherassistant-messages');\n        if (!messagesContainer) {\n            return;\n        }\n\n        const messageDiv = document.createElement('div');\n        messageDiv.className = `teacherassistant-message teacherassistant-message-${sender}`;\n\n        const contentDiv = document.createElement('div');\n        contentDiv.className = 'teacherassistant-message-content';\n        contentDiv.textContent = text;\n\n        messageDiv.appendChild(contentDiv);\n        messagesContainer.appendChild(messageDiv);\n        messagesContainer.scrollTop = messagesContainer.scrollHeight;\n    }\n\n    /**\n     * Show loading indicator.\n     */\n    showLoading() {\n        const messagesContainer = document.getElementById('teacherassistant-messages');\n        if (!messagesContainer) {\n            return;\n        }\n\n        const loadingDiv = document.createElement('div');\n        loadingDiv.id = 'teacherassistant-loading';\n        loadingDiv.className = 'teacherassistant-message teacherassistant-message-assistant';\n\n        const contentDiv = document.createElement('div');\n        contentDiv.className = 'teacherassistant-message-content';\n        contentDiv.innerHTML = '<i class=\"fa fa-spinner fa-spin\"></i> Thinking...';\n\n        loadingDiv.appendChild(contentDiv);\n        messagesContainer.appendChild(loadingDiv);\n        messagesContainer.scrollTop = messagesContainer.scrollHeight;\n    }\n\n    /**\n     * Hide loading indicator.\n     */\n    hideLoading() {\n        const loading = document.getElementById('teacherassistant-loading');\n        if (loading) {\n            loading.remove();\n        }\n    }\n}\n\nexport const init = (courseId) => {\n    console.log('Teacher Assistant popup initialized');\n    const manager = new PopupManager(courseId);\n    manager.init();\n};\n"],"names":["_interopRequireDefault","e","__esModule","default","_templates","_ajax","_notification","PopupManager","constructor","courseId","this","isMinimized","init","render","attachEventHandlers","console","log","container","document","getElementById","createElement","id","body","appendChild","context","courseid","html","Templates","innerHTML","error","Notification","exception","toggleBtn","minimizeBtn","expandBtn","sendBtn","input","addEventListener","togglePopup","minimizePopup","expandToFullPage","sendMessage","key","ctrlKey","shiftKey","preventDefault","popup","content","classList","remove","add","style","display","url","M","cfg","wwwroot","window","open","message","value","trim","addMessage","showLoading","response","Ajax","call","methodname","args","hideLoading","text","sender","messagesContainer","messageDiv","className","contentDiv","textContent","scrollTop","scrollHeight","loadingDiv","loading","_exports"],"mappings":"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"}